<?php

namespace App\Filament\Resources;

use App\Filament\Resources\RoleResource\Pages;
use Spatie\Permission\Models\Role;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;
use Spatie\Permission\Models\Permission;

class RoleResource extends Resource
{
    protected static ?string $model = Role::class;

    protected static ?string $navigationIcon = 'heroicon-o-key';
    
    protected static ?string $navigationGroup = 'âš™ï¸ Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¸ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸';
    protected static ?string $navigationLabel = 'Ð Ð¾Ð»Ð¸';
    protected static ?int $navigationSort = 60;

    protected static ?string $modelLabel = 'Ñ€Ð¾Ð»ÑŒ';
    protected static ?string $pluralModelLabel = 'Ð Ð¾Ð»Ð¸';

    public static function getPageLabels(): array
    {
        return [
            'index' => 'Ð Ð¾Ð»Ð¸',
            'create' => 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ',
            'edit' => 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ',
        ];
    }

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                Forms\Components\Section::make('ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ')
                    ->schema([
                        Forms\Components\TextInput::make('name')
                            ->required()
                            ->maxLength(255)
                            ->unique(ignoreRecord: true)
                            ->label('ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ€Ð¾Ð»Ð¸')
                            ->placeholder('ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€, ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€...'),
                    ]),
                    
                Forms\Components\Section::make('Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ')
                    ->schema([
                        Forms\Components\CheckboxList::make('permissions')
                            ->relationship('permissions', 'name')
                            ->searchable()
                            ->bulkToggleable()
                            ->label('Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ')
                            ->helperText('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ Ñ€Ð¾Ð»Ð¸')
                            ->gridDirection('row')
                            ->columns(2)
                            ->getOptionLabelFromRecordUsing(fn (Permission $record) => 
                                match($record->name) {
                                    'create_work_requests' => 'ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÑÐ²Ð¾Ðº',
                                    'view_work_requests' => 'ðŸ‘ï¸ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð·Ð°ÑÐ²Ð¾Ðº',
                                    'edit_work_requests' => 'âœï¸ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÑÐ²Ð¾Ðº',
                                    'delete_work_requests' => 'ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°ÑÐ²Ð¾Ðº',
                                    'manage_users' => 'ðŸ‘¥ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸',
                                    'manage_roles' => 'ðŸ”‘ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€Ð¾Ð»ÑÐ¼Ð¸',
                                    'manage_permissions' => 'ðŸ” Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸ÑÐ¼Ð¸',
                                    default => $record->name
                                }
                            ),
                    ]),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('name')
                    ->searchable()
                    ->sortable()
                    ->label('ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ€Ð¾Ð»Ð¸'),
                    
                Tables\Columns\TextColumn::make('permissions_count')
                    ->counts('permissions')
                    ->label('ÐšÐ¾Ð»-Ð²Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹')
                    ->sortable()
                    ->badge()
                    ->color(fn ($state) => $state > 0 ? 'success' : 'gray'),
                    
                Tables\Columns\TextColumn::make('users_count')
                    ->counts('users')
                    ->label('ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹')
                    ->sortable()
                    ->badge()
                    ->color('info'),
                    
                Tables\Columns\TextColumn::make('created_at')
                    ->dateTime('d.m.Y H:i')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true)
                    ->label('Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°'),
                    
                Tables\Columns\TextColumn::make('updated_at')
                    ->dateTime('d.m.Y H:i')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true)
                    ->label('ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°'),
            ])
            ->filters([
                Tables\Filters\Filter::make('has_permissions')
                    ->label('Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸ÑÐ¼Ð¸')
                    ->query(fn ($query) => $query->has('permissions')),
                    
                Tables\Filters\Filter::make('has_users')
                    ->label('Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸')
                    ->query(fn ($query) => $query->has('users')),
            ])
            ->actions([
                Tables\Actions\EditAction::make()
                    ->label('Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ'),
                Tables\Actions\DeleteAction::make()
                    ->label('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ'),
            ])
            ->bulkActions([
                Tables\Actions\BulkActionGroup::make([
                    Tables\Actions\DeleteBulkAction::make()
                        ->label('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ'),
                ]),
            ])
            ->emptyStateHeading('ÐÐµÑ‚ Ñ€Ð¾Ð»ÐµÐ¹')
            ->emptyStateDescription('Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ñ€Ð¾Ð»ÑŒ.')
            ->emptyStateActions([
                Tables\Actions\CreateAction::make()
                    ->label('Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ'),
            ])
            ->defaultSort('name', 'asc');
    }

    public static function getRelations(): array
    {
        return [
            // Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð¿Ð¾Ð·Ð¶Ðµ RelationManager Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
        ];
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListRoles::route('/'),
            'create' => Pages\CreateRole::route('/create'),
            'edit' => Pages\EditRole::route('/{record}/edit'),
        ];
    }
}
