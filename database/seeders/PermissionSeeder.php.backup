<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Permission;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use ReflectionClass;
use App\Policies\{
    AssignmentPolicy, ShiftPolicy, WorkRequestPolicy, UserPolicy,
    ExpensePolicy, CompensationPolicy, TraineeRequestPolicy
};

class PermissionSeeder extends Seeder
{
    /**
     * Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
     */
    private array $groupMapping = [
        'Activity' => 'activity',
        'Address' => 'address',
        'Assignment' => 'assignment',
        'Candidate' => 'candidate',
        'Category' => 'category',
        'Compensation' => 'compensation',
        'Contractor' => 'contractor',
        'ContractType' => 'contract_type',
        'Department' => 'department',
        'EmploymentHistory' => 'employment_history',
        'Expense' => 'expense',
        'filament' => 'system',
        'HiringDecision' => 'hiring_decision',
        'InitiatorGrant' => 'initiator_grant',
        'Interview' => 'interview',
        'MassPersonnelReport' => 'mass_personnel_report',
        'panel' => 'system',
        'Permission' => 'permission',
        'Photo' => 'photo',
        'PositionChangeRequest' => 'position_change_request',
        'Project' => 'project',
        'Purpose' => 'purpose',
        'RecruitmentRequest' => 'recruitment_request',
        'reports' => 'report',
        'Role' => 'role',
        'settings' => 'system',
        'Shift' => 'shift',
        'Specialty' => 'specialty',
        'statistics' => 'report',
        'TaxStatus' => 'tax_status',
        'TraineeRequest' => 'trainee_request',
        'User' => 'user',
        'Vacancy' => 'vacancy',
        'VisitedLocation' => 'visited_location',
        'WorkRequest' => 'work_request',
        'WorkType' => 'work_type',
    ];

    /**
     * ÐœÐ°Ð¿Ð¿Ð¸Ð½Ð³ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ðº Ð¼Ð¾Ð´ÐµÐ»ÑÐ¼
     */
    private array $policyToModel = [
        AssignmentPolicy::class => 'assignment',
        ShiftPolicy::class => 'shift',
        WorkRequestPolicy::class => 'workrequest',
        UserPolicy::class => 'user',
        ExpensePolicy::class => 'expense',
        CompensationPolicy::class => 'compensation',
        TraineeRequestPolicy::class => 'traineerequest',
    ];

    public function run(): void
    {
        $this->command->info('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ PermissionSeeder...');
        
        if (!Schema::hasColumn('permissions', 'group')) {
            $this->command->error('âŒ Ð’ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ permissions Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° "group"');
            return;
        }
        
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();
        
        DB::transaction(function () {
            $stats = [
                'updated' => 0,
                'created' => 0,
                'skipped' => 0,
            ];
            
            // 1. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ CRUD Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
            $models = $this->getModels();
            $allPermissions = [];
            
            foreach ($models as $model) {
                $modelName = strtolower(class_basename($model));
                $group = $this->getGroupForModel($modelName);
                
                // Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ CRUD Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
                $crudPermissions = $this->generateCrudPermissions($modelName, $group);
                $allPermissions = array_merge($allPermissions, $crudPermissions);
                
                // Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð¸Ð· Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº
                $specificPermissions = $this->getSpecificPermissionsForModel($modelName, $group);
                $allPermissions = array_merge($allPermissions, $specificPermissions);
            }
            
            // 2. ÐžÐ±Ñ‰Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
            $systemPermissions = [
                ['name' => 'access_panel', 'group' => 'system', 'description' => 'Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ'],
                ['name' => 'manage_settings', 'group' => 'system', 'description' => 'Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹'],
                ['name' => 'view_reports', 'group' => 'report', 'description' => 'ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²'],
                ['name' => 'export_data', 'group' => 'system', 'description' => 'Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…'],
                ['name' => 'import_data', 'group' => 'system', 'description' => 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…'],
            ];
            
            foreach ($systemPermissions as $perm) {
                $allPermissions[] = $perm + ['guard_name' => 'web'];
            }
            
            // 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
            foreach ($allPermissions as $permissionData) {
                $permission = Permission::firstOrCreate(
                    ['name' => $permissionData['name']],
                    $permissionData
                );
                
                if ($permission->wasRecentlyCreated) {
                    $stats['created']++;
                } else {
                    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ, ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
                    if ($permission->description !== $permissionData['description'] || 
                        $permission->group !== $permissionData['group']) {
                        $permission->update([
                            'description' => $permissionData['description'],
                            'group' => $permissionData['group']
                        ]);
                        $stats['updated']++;
                    } else {
                        $stats['skipped']++;
                    }
                }
            }
            
            // Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
            $this->command->info("ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:");
            $this->command->info("  âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾: {$stats['created']}");
            $this->command->info("  ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {$stats['updated']}");
            $this->command->info("  â­ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾: {$stats['skipped']}");
            $this->command->info("  ðŸ“ˆ Ð’ÑÐµÐ³Ð¾ Ð² Ð±Ð°Ð·Ðµ: " . Permission::count());
            
            // Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼
            $groupStats = Permission::select('group', DB::raw('count(*) as count'))
                ->whereNotNull('group')
                ->groupBy('group')
                ->orderBy('count', 'desc')
                ->pluck('count', 'group')
                ->toArray();
            
            if (!empty($groupStats)) {
                $this->command->info("\nðŸ“Š Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹:");
                foreach ($groupStats as $group => $count) {
                    $this->command->info("  - {$group}: {$count}");
                }
            }
        });
        
        $this->command->info('âœ… PermissionSeeder Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!');
    }
    
    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
     */
    private function getModels(): array
    {
        $models = [];
        $modelPath = app_path('Models');
        
        $files = \Illuminate\Support\Facades\File::allFiles($modelPath);
        
        foreach ($files as $file) {
            $model = 'App\\Models\\' . $file->getFilenameWithoutExtension();
            if (class_exists($model)) {
                $models[] = $model;
            }
        }
        
        return $models;
    }
    
    /**
     * ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸
     */
    private function getGroupForModel(string $modelName): string
    {
        $map = [
            'user' => 'user',
            'assignment' => 'assignment',
            'shift' => 'shift',
            'workrequest' => 'work_request',
            'expense' => 'expense',
            'compensation' => 'compensation',
            'candidate' => 'candidate',
            'vacancy' => 'vacancy',
            'recruitmentrequest' => 'recruitment',
            'interview' => 'recruitment',
            'hiringdecision' => 'recruitment',
            'department' => 'department',
            'contractor' => 'contractor',
            'project' => 'project',
            'purpose' => 'purpose',
            'address' => 'address',
            'category' => 'category',
            'specialty' => 'specialty',
        ];
        
        return $map[$modelName] ?? 'system';
    }
    
    /**
     * Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ CRUD Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸
     */
    private function generateCrudPermissions(string $modelName, string $group): array
    {
        $permissions = [];
        $actions = ['view_any', 'view', 'create', 'update', 'delete', 'restore', 'force_delete'];
        
        $modelNameForDisplay = $this->getModelNameForDisplay($modelName);
        
        foreach ($actions as $action) {
            $permissionName = "{$action}_{$modelName}";
            $description = $this->getDescriptionForPermission($action, $modelNameForDisplay);
            
            $permissions[] = [
                'name' => $permissionName,
                'group' => $group,
                'description' => $description,
                'guard_name' => 'web',
            ];
        }
        
        return $permissions;
    }
    
    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¸Ð· Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº
     */
    private function getSpecificPermissionsForModel(string $modelName, string $group): array
    {
        $specifics = [
            'assignment' => [
                ['name' => 'confirm_assignment', 'description' => 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ'],
                ['name' => 'reject_assignment', 'description' => 'ÐžÑ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ'],
                ['name' => 'cancel_assignment', 'description' => 'ÐžÑ‚Ð¼ÐµÐ½Ð° Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ'],
                ['name' => 'reassign_assignment', 'description' => 'ÐŸÐµÑ€ÐµÐ½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ'],
            ],
            'shift' => [
                ['name' => 'start_shift', 'description' => 'ÐÐ°Ñ‡Ð°Ð»Ð¾ ÑÐ¼ÐµÐ½Ñ‹'],
                ['name' => 'end_shift', 'description' => 'Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ ÑÐ¼ÐµÐ½Ñ‹'],
                ['name' => 'approve_shift', 'description' => 'Ð£Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÑÐ¼ÐµÐ½Ñ‹'],
            ],
            'workrequest' => [
                ['name' => 'publish_workrequest', 'description' => 'ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð·Ð°ÑÐ²ÐºÐ¸'],
                ['name' => 'take_workrequest', 'description' => 'Ð’Ð·ÑÑ‚Ð¸Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ'],
            ],
            'traineerequest' => [
                ['name' => 'approve_traineerequest', 'description' => 'Ð£Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ Ð½Ð° ÑÑ‚Ð°Ð¶Ð¸Ñ€Ð¾Ð²ÐºÑƒ'],
            ],
        ];
        
        $permissions = $specifics[$modelName] ?? [];
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ðº ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸ÑŽ
        foreach ($permissions as &$permission) {
            $permission['group'] = $group;
            $permission['guard_name'] = 'web';
        }
        
        return $permissions;
    }
    
    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ðµ Ð¸Ð¼Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸
     */
    private function getModelNameForDisplay(string $modelName): string
    {
        $map = [
            'user' => 'Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹',
            'assignment' => 'Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹',
            'shift' => 'ÑÐ¼ÐµÐ½',
            'workrequest' => 'Ð·Ð°ÑÐ²Ð¾Ðº Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹',
            'expense' => 'Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²',
            'compensation' => 'ÐºÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ð¹',
            'candidate' => 'ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²',
            'vacancy' => 'Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹',
            'recruitmentrequest' => 'Ð·Ð°ÑÐ²Ð¾Ðº Ð½Ð° Ð¿Ð¾Ð´Ð±Ð¾Ñ€',
            'interview' => 'ÑÐ¾Ð±ÐµÑÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ð¹',
            'hiringdecision' => 'Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð¾ Ð½Ð°Ð¹Ð¼Ðµ',
            'department' => 'Ð¾Ñ‚Ð´ÐµÐ»Ð¾Ð²',
            'contractor' => 'Ð¿Ð¾Ð´Ñ€ÑÐ´Ñ‡Ð¸ÐºÐ¾Ð²',
            'project' => 'Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²',
            'purpose' => 'Ñ†ÐµÐ»ÐµÐ¹',
            'address' => 'Ð°Ð´Ñ€ÐµÑÐ¾Ð²',
            'category' => 'ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹',
            'specialty' => 'ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÐµÐ¹',
        ];
        
        return $map[$modelName] ?? $modelName;
    }
    
    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
     */
    private function getDescriptionForPermission(string $action, string $modelName): string
    {
        $actionMap = [
            'view_any' => 'ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð²ÑÐµÑ…',
            'view' => 'ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€',
            'create' => 'Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ',
            'update' => 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ',
            'delete' => 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ',
            'restore' => 'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ',
            'force_delete' => 'ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ',
        ];
        
        $actionText = $actionMap[$action] ?? ucfirst($action);
        
        return "{$actionText} {$modelName}";
    }
    
    /**
     * ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹
     */
    private function normalizeGroup(string $group): string
    {
        $group = trim($group);
        
        if (isset($this->groupMapping[$group])) {
            return $this->groupMapping[$group];
        }
        
        $normalized = strtolower(preg_replace('/[^a-zA-Z0-9]+/', '_', $group));
        $normalized = trim($normalized, '_');
        
        return $normalized;
    }
}
