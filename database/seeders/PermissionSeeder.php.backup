<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Permission;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

class PermissionSeeder extends Seeder
{
    /**
     * Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
     * ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ Ðº ÐµÐ´Ð¸Ð½Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ snake_case
     */
    private array $groupMapping = [
        // Ð ÑƒÑÑÐºÐ¸Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ -> Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ðµ snake_case
        'Activity' => 'activity',
        'Address' => 'address',
        'Assignment' => 'assignment',
        'Candidate' => 'candidate',
        'Category' => 'category',
        'Compensation' => 'compensation',
        'Contractor' => 'contractor',
        'ContractType' => 'contract_type',
        'Department' => 'department',
        'EmploymentHistory' => 'employment_history',
        'Expense' => 'expense',
        'filament' => 'system', // Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ system
        'HiringDecision' => 'hiring_decision',
        'InitiatorGrant' => 'initiator_grant',
        'Interview' => 'interview',
        'MassPersonnelReport' => 'mass_personnel_report',
        'panel' => 'system', // Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ system
        'Permission' => 'permission',
        'Photo' => 'photo',
        'PositionChangeRequest' => 'position_change_request',
        'Project' => 'project',
        'Purpose' => 'purpose',
        'RecruitmentRequest' => 'recruitment_request',
        'reports' => 'report',
        'Role' => 'role',
        'settings' => 'system',
        'Shift' => 'shift',
        'Specialty' => 'specialty',
        'statistics' => 'report',
        'TaxStatus' => 'tax_status',
        'TraineeRequest' => 'trainee_request',
        'User' => 'user',
        'Vacancy' => 'vacancy',
        'VisitedLocation' => 'visited_location',
        'WorkRequest' => 'work_request',
        'WorkType' => 'work_type',
        'database' => 'system',
        'data' => 'system',
        'payments' => 'financial',
        'hiringdecision' => 'hiring_decision',
        
        // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸Ð· Excel
        'AddressProject' => 'address',
        'AddressTemplate' => 'address',
        'CandidateDecision' => 'candidate',
        'CandidateStatusHistory' => 'candidate',
        'ContractorRate' => 'contractor',
        'ContractorWorker' => 'contractor',
        'PurposeAddressRule' => 'purpose',
        'PurposePayerCompany' => 'purpose',
        'PurposeTemplate' => 'purpose',
        'VacancyCondition' => 'vacancy',
        'VacancyRequirement' => 'vacancy',
        'VacancyTask' => 'vacancy',
        'WorkRequestStatus' => 'work_request',
    ];
    
    /**
     * Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÑŽÐ´Ð° ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð² Ð¸Ð· generated_permissions.php
     */
    private array $excelPermissions = [
        // Ð¡ÑŽÐ´Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð²ÑÑ‚Ð°Ð²Ð»ÐµÐ½ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð²
    ];

    public function run(): void
    {
        $this->command->info('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº PermissionSeeder...');
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ permissions
        if (!Schema::hasColumn('permissions', 'group')) {
            $this->command->error('âŒ Ð’ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ permissions Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° "group"');
            $this->command->info('Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ: sail artisan migrate');
            return;
        }
        
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();
        
        DB::transaction(function () {
            $stats = [
                'updated' => 0,
                'created' => 0,
                'skipped' => 0,
            ];
            
            // Ð•ÑÐ»Ð¸ Ð¼Ð°ÑÑÐ¸Ð² Ð¿ÑƒÑÑ‚Ð¾Ð¹, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ
            if (empty($this->excelPermissions)) {
                $this->command->warn('âš ï¸  ÐœÐ°ÑÑÐ¸Ð² excelPermissions Ð¿ÑƒÑÑ‚Ð¾Ð¹!');
                $this->command->info('Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ convert_excel_to_php.php Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ð°');
                return;
            }
            
            $this->command->info("ðŸ“Š Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ " . count($this->excelPermissions) . " Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð¸Ð· Excel");
            
            // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ
            foreach ($this->excelPermissions as $name => $excelData) {
                $normalizedGroup = $this->normalizeGroup($excelData['group']);
                
                // Ð˜Ñ‰ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
                $permission = Permission::where('name', $name)->first();
                
                if ($permission) {
                    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½ÑƒÐ¶Ð½Ð¾ Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                    $needsUpdate = false;
                    
                    if ($permission->group !== $normalizedGroup) {
                        $permission->group = $normalizedGroup;
                        $needsUpdate = true;
                    }
                    
                    if ($permission->description !== $excelData['description']) {
                        $permission->description = $excelData['description'];
                        $needsUpdate = true;
                    }
                    
                    if ($needsUpdate) {
                        $permission->save();
                        $stats['updated']++;
                    } else {
                        $stats['skipped']++;
                    }
                } else {
                    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
                    Permission::create([
                        'name' => $name,
                        'group' => $normalizedGroup,
                        'description' => $excelData['description'],
                        'guard_name' => 'web',
                    ]);
                    $stats['created']++;
                }
            }
            
            // Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼
            $groupStats = Permission::select('group', DB::raw('count(*) as count'))
                ->whereNotNull('group')
                ->groupBy('group')
                ->orderBy('count', 'desc')
                ->pluck('count', 'group')
                ->toArray();
            
            $this->command->info("ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:");
            $this->command->info("  âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾: {$stats['created']}");
            $this->command->info("  ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {$stats['updated']}");
            $this->command->info("  â­ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾: {$stats['skipped']}");
            $this->command->info("  ðŸ“ˆ Ð’ÑÐµÐ³Ð¾ Ð² Ð±Ð°Ð·Ðµ: " . Permission::count());
            
            if (!empty($groupStats)) {
                $this->command->info("\nðŸ“Š Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹:");
                foreach ($groupStats as $group => $count) {
                    $this->command->info("  - {$group}: {$count}");
                }
            }
        });
        
        $this->command->info('âœ… PermissionSeeder Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!');
    }
    
    /**
     * ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹
     */
    private function normalizeGroup(string $group): string
    {
        $group = trim($group);
        
        // Ð•ÑÐ»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÐµÑÑ‚ÑŒ Ð² Ð¼Ð°Ð¿Ð¿Ð¸Ð½Ð³Ðµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
        if (isset($this->groupMapping[$group])) {
            return $this->groupMapping[$group];
        }
        
        // ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ðº snake_case
        $normalized = strtolower(preg_replace('/[^a-zA-Z0-9]+/', '_', $group));
        $normalized = trim($normalized, '_');
        
        return $normalized;
    }
    
    /**
     * ÐœÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸)
     */
    public function getGroupStatistics(): array
    {
        $groups = [];
        foreach ($this->excelPermissions as $data) {
            $originalGroup = $data['group'];
            $normalizedGroup = $this->normalizeGroup($originalGroup);
            $groups[$originalGroup] = $normalizedGroup;
        }
        
        return array_unique($groups);
    }
}
