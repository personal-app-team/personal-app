**🔐 Улучшение системы ролей и разрешений**

**📅 Дата создания плана: 04.12.2024**

**🎯 Цель**

Создать гибкую и удобную систему управления правами доступа, которая поддерживает:

- Стандартные роли с фиксированными разрешениями
- Роль Manager с индивидуальными разрешениями для каждого пользователя
- Удобный интерфейс на русском языке
- Группировку разрешений по модулям системы

**🚀 План реализации**

**Этап 1: Подготовка инфраструктуры (1 день)**

**1.1. Модель для кастомных разрешений менеджеров**

- Создать миграцию create\_manager\_permissions\_table
- Создать модель ManagerPermission с полями:
  - user\_id - связь с пользователем
  - permission\_name - название разрешения
  - scope (JSON) - дополнительные параметры (отдел, проект и т.д.)
- Добавить отношения в модели User

**1.2. Расширение модели Permission**

- Добавить миграцию для расширения таблицы permissions:
  - group (string) - группа для группировки
  - description (text) - человекочитаемое описание
  - is\_system (boolean) - системное разрешение (нельзя удалить)
- Обновить модель Permission

**Этап 2: Создание Filament Resources (2 дня)**

**2.1. PermissionResource**

- Создать PermissionResource с:
  - Группировкой разрешений по полю group
  - Русскими названиями и описаниями
  - Статистикой использования (сколько ролей/пользователей)

**2.2. Улучшение RoleResource**

- Обновить форму RoleResource для группировки разрешений
- Добавить статистику по количеству пользователей с ролью
- Добавить экспорт/импорт разрешений для ролей

**2.3. Улучшение UserResource**

- Добавить секцию "Прямые разрешения" (в дополнение к ролям)
- Добавить секцию "Кастомные разрешения менеджера"
- Создать виджет для быстрого управления правами пользователя

**2.4. ManagerPermissionResource (опционально)**

- Создать отдельный ресурс для управления кастомными разрешениями

**Этап 3: Система разрешений для менеджеров (1 день)**

**3.1. Методы для работы с кастомными разрешениями**

- В модели User добавить методы:
  - hasManagerPermission() - проверка разрешения
  - syncManagerPermissions() - синхронизация разрешений
  - getManagerPermissions() - получение всех кастомных разрешений

**3.2. Middleware для проверки разрешений менеджеров**

- Создать middleware CheckManagerPermission
- Интегрировать в Filament и API маршруты

**3.3. Политики доступа**

- Создать политики для проверки кастомных разрешений
- Интегрировать с существующими политиками

**Этап 4: Сидеры и начальные данные (0.5 дня)**

**4.1. PermissionSeeder**

- Создать сидер с полным списком разрешений на русском
- Группировать по модулям: Система, Пользователи, Заявки, Назначения и т.д.

**4.2. RoleSeeder**

- Обновить существующий RoleSeeder
- Назначить стандартные разрешения для базовых ролей

**4.3. ManagerPermissionSeeder (тестовый)**

- Создать тестовые кастомные разрешения для менеджеров

**Этап 5: Тестирование и документация (1 день)**

**5.1. Тестирование**

- Протестировать назначение стандартных разрешений
- Протестировать кастомные разрешения менеджеров
- Проверить работу middleware и политик

**5.2. Документация**

- Создать инструкцию для администраторов
- Документировать API для работы с разрешениями
- Создать чек-лист проверки безопасности

**📊 Структура разрешений**

**Группы разрешений:**

1. **Система** - базовый доступ к панели управления
1. **Пользователи** - управление пользователями и ролями
1. **Заявки** - WorkRequest и связанные процессы
1. **Назначения** - Assignment система
1. **Смены** - Shift и финансовые операции
1. **Подрядчики** - Contractor и ставки
1. **Стажеры** - TraineeRequest система
1. **Подбор** - Recruitment модуль
1. **Отчеты** - аналитика и отчетность
1. **Настройки** - системные настройки

**Стандартные роли и их разрешения:**

**1. Admin (Администратор)**

- Полный доступ ко всем разрешениям
- Может управлять ролями и разрешениями

**2. Initiator (Инициатор)**

- Создание и редактирование своих WorkRequest
- Просмотр назначений
- Создание TraineeRequest

**3. Dispatcher (Диспетчер)**

- Все разрешения Initiator
- Управление Assignment
- Комплектование заявок исполнителями

**4. Executor (Исполнитель)**

- Просмотр своих Shift
- Создание ShiftExpense
- Отметка о начале/окончании смены

**5. HR (Кадровик)**

- Управление Vacancy и RecruitmentRequest
- Просмотр Candidate и Interview
- Утверждение TraineeRequest (первый этап)

**6. Manager (Руководитель)**

- **Индивидуальные разрешения для каждого пользователя**
- Базовые разрешения: просмотр отчетов, утверждение бюджетов
- Кастомные разрешения через ManagerPermission

**7. Trainee (Стажер)**

- Ограниченный доступ к системе
- Просмотр своих назначений и смен

**8. Contractor (Подрядчик)**

- Управление своими исполнителями
- Просмотр смен и финансов по своим сотрудникам
- Управление ставками (ContractorRate)

**🔧 Техническая реализация**

**1. Таблицы базы данных:**

sql

*-- Расширенная таблица permissions*

ALTER TABLE permissions ADD COLUMN group VARCHAR(100);

ALTER TABLE permissions ADD COLUMN description TEXT;

ALTER TABLE permissions ADD COLUMN is\_system BOOLEAN DEFAULT false;

*-- Таблица для кастомных разрешений менеджеров*

CREATE TABLE manager\_permissions (

`    `id BIGINT UNSIGNED AUTO\_INCREMENT PRIMARY KEY,

`    `user\_id BIGINT UNSIGNED NOT NULL,

`    `permission\_name VARCHAR(255) NOT NULL,

`    `scope JSON NULL,

`    `created\_at TIMESTAMP NULL,

`    `updated\_at TIMESTAMP NULL,

`    `UNIQUE KEY unique\_manager\_permission (user\_id, permission\_name),

`    `FOREIGN KEY (user\_id) REFERENCES users(id) ON DELETE CASCADE

);

**2. Классы и отношения:**

php

*// Модель ManagerPermission*

class ManagerPermission extends Model

{

`    `protected $fillable = ['user\_id', 'permission\_name', 'scope'];

`    `protected $casts = ['scope' => 'array'];



`    `public function user()

`    `{

`        `return $this->belongsTo(User::class);

`    `}

}

*// Расширение модели User*

class User extends Authenticatable

{

`    `use HasRoles;



`    `public function managerPermissions()

`    `{

`        `return $this->hasMany(ManagerPermission::class);

`    `}



`    `public function hasManagerPermission($permission, $scope = null)

`    `{

`        `*// Логика проверки кастомного разрешения*

`    `}

}

**3. Filament Resources:**

- PermissionResource - управление всеми разрешениями
- RoleResource - управление ролями (уже есть, нужно улучшить)
- UserResource - управление пользователями (уже есть, расширить)
- ManagerPermissionResource - управление кастомными разрешениями

**📈 Приоритеты реализации**

**Высокий приоритет (неделя 1):**

1. Создание PermissionResource с группировкой
1. Добавление кастомных разрешений для менеджеров
1. Обновление UserResource для управления прямыми разрешениями

**Средний приоритет (неделя 2):**

4. Middleware для проверки кастомных разрешений
4. Виджет для быстрого управления правами
4. Обновление сидеров с русскими описаниями

**Низкий приоритет (неделя 3):**

7. Экспорт/импорт разрешений
7. Расширенная аналитика использования разрешений
7. API для управления разрешениями

**🧪 Тестовые сценарии**

**Сценарий 1: Назначение стандартных ролей**

1. Администратор создает пользователя
1. Назначает роль "Initiator"
1. Проверяет, что у пользователя есть разрешения:
   1. view\_work\_requests
   1. create\_work\_requests
   1. view\_assignments

**Сценарий 2: Кастомные разрешения менеджера**

1. Администратор создает пользователя с ролью "Manager"
1. В секции "Кастомные разрешения" добавляет:
   1. Разрешение: approve\_budget
   1. Scope: {"department": "IT", "max\_amount": 100000}
1. Проверяет, что пользователь может утверждать бюджет в IT отделе до 100,000 руб.

**Сценарий 3: Прямые разрешения пользователю**

1. Администратор редактирует пользователя
1. В секции "Прямые разрешения" добавляет view\_financial\_reports
1. Проверяет, что пользователь видит финансовые отчеты, даже если его роль этого не предусматривает

**⚠️ Риски и ограничения**

**Технические риски:**

1. **Производительность** - при большом количестве разрешений и пользователей
1. **Сложность отладки** - комбинация ролевых и кастомных разрешений
1. **Миграция данных** - обновление существующих разрешений

**Бизнес-риски:**

1. **Ошибки назначения прав** - могут привести к утечке данных
1. **Сложность администрирования** - для неопытных администраторов
1. **Поддержка** - необходимо обучение администраторов

**Ограничения:**

1. Кастомные разрешения только для роли "Manager"
1. Максимальное количество кастомных разрешений на пользователя: 20
1. Scope ограничен JSON размером 1MB

**📝 Документация для администраторов**

**Быстрый старт:**

1. Создайте пользователя
1. Назначьте базовую роль
1. Для менеджеров: добавьте кастомные разрешения
1. Для особых случаев: добавьте прямые разрешения

**Горячие клавиши в Filament:**

- Ctrl + F - поиск разрешения
- Ctrl + G - группировка разрешений
- Ctrl + S - быстрый экспорт разрешений роли

**Чек-лист безопасности:**

- Проверить, что у стажеров нет доступа к финансовым данным
- Проверить, что подрядчики не видят данные других подрядчиков
- Проверить, что HR не могут утверждать бюджеты
- Проверить, что менеджеры имеют только назначенные им разрешения

**🎯 Ожидаемые результаты**

**После реализации:**

1. **Удобный интерфейс** - группировка, поиск, русские названия
1. **Гибкая система** - поддержка кастомных разрешений для менеджеров
1. **Безопасность** - четкое разделение прав доступа
1. **Масштабируемость** - легко добавлять новые разрешения и роли

**Метрики успеха:**

- Время назначения прав новому пользователю: < 2 минут
- Количество ошибок назначения прав: 0
- Удовлетворенность администраторов: > 90%
-----
**Срок реализации:** 2-3 недели\
**Ответственный:** Команда разработки\
**Статус:** Планирование

*Документ будет обновляться по мере реализации.*

